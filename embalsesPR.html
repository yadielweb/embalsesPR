<!DOCTYPE html>
<html style="font-size: 16px;">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="page_type" content="np-template-header-footer-from-plugin">
    <title>embalsesPR</title>
    <link rel="stylesheet" href="nicepage.css" media="screen">
<link rel="stylesheet" href="embalsesPR.css" media="screen">
    <script class="u-script" type="text/javascript" src="jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 3.15.3, nicepage.com">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i">
    
    
    
    
    <script type="application/ld+json">{
		"@context": "http://schema.org",
		"@type": "Organization",
		"name": "embalsesPR",
		"url": "index.html"
}</script>
    <meta property="og:title" content="embalsesPR">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#478ac9">
    <link rel="canonical" href="index.html">
    <meta property="og:url" content="index.html">
  </head>
  <body class="u-body"><header class="u-clearfix u-header u-header" id="sec-fd80"><div class="u-clearfix u-sheet u-sheet-1">
        <nav class="u-menu u-menu-dropdown u-offcanvas u-menu-1">
          <div class="menu-collapse" style="font-size: 1rem; letter-spacing: 0px;">
            <a class="u-button-style u-custom-left-right-menu-spacing u-custom-padding-bottom u-custom-top-bottom-menu-spacing u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="#">
              <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#menu-hamburger"></use></svg>
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="menu-hamburger" viewBox="0 0 16 16" style="width: 16px; height: 16px;"><rect y="1" width="16" height="2"></rect><rect y="7" width="16" height="2"></rect><rect y="13" width="16" height="2"></rect>
</symbol>
</defs></svg>
            </a>
          </div>
          <div class="u-custom-menu u-nav-container">
            <ul class="u-nav u-unstyled u-nav-1"><li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="yadielweb.github.io" style="padding: 10px 20px;">Pagina Principal</a>
</li><li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="embalsesPR.html" style="padding: 10px 20px;">embalsesPR</a>
</li></ul>
          </div>
          <div class="u-custom-menu u-nav-container-collapse">
            <div class="u-black u-container-style u-inner-container-layout u-opacity u-opacity-95 u-sidenav">
              <div class="u-sidenav-overflow">
                <div class="u-menu-close"></div>
                <ul class="u-align-center u-nav u-popupmenu-items u-unstyled u-nav-2"><li class="u-nav-item"><a class="u-button-style u-nav-link" href="yadielweb.github.io" style="padding: 10px 20px;">Pagina Principal</a>
</li><li class="u-nav-item"><a class="u-button-style u-nav-link" href="embalsesPR.html" style="padding: 10px 20px;">embalsesPR</a>
</li></ul>
              </div>
            </div>
            <div class="u-black u-menu-overlay u-opacity u-opacity-70"></div>
          </div>
        </nav>
        <div class="u-image u-image-circle u-image-1" alt="" data-image-width="1500" data-image-height="1567"></div>
      </div></header>
    <section class="u-clearfix u-section-1" id="sec-3466">
      <div class="u-clearfix u-sheet u-valign-middle-lg u-valign-middle-md u-valign-middle-sm u-valign-middle-xs u-sheet-1">
        <p class="u-align-left-xs u-text u-text-1">El proyecto original se encuentra en:</p>
        <p class="u-text u-text-2">
          <a class="u-active-none u-border-none u-btn u-button-link u-button-style u-hover-none u-none u-text-palette-1-base u-btn-1" href="http://embalsespr.uprh.edu/">embalsespr.uprh.edu</a>
        </p>
      </div>
    </section>
    <section class="u-clearfix u-section-2" id="sec-eed0">
      <div class="u-clearfix u-sheet u-valign-middle-xl u-sheet-1">
        <h1 class="u-align-center u-text u-text-1">embalsesPR V2</h1>
        <p class="u-align-left u-text u-text-2">embalsesPR V2 by Yadiel&nbsp;es una aplicación para visualizar el estado actual de los embalses en Puerto Rico utilizando datos del Servicio Geológico de los Estados Unidos (USGS por sus siglas en inglés). Dependiendo del tráfico en el servidor (y los instrumentos del USGS) el tiempo de búsqueda puede variar. Según USGS los datos tienen estado provisional y podrian variar luego de una revisión.&nbsp;<br>
          <br>De ser necesario recarge la página.<br>
          <br>embalsesPR V2 es un proyecto de Yadiel E. Torres Laboy para el curso COMP 4010 del Departamento de Matemáticas de la Universidad de Puerto Rico en Humacao. Pueden enviar sus preguntas, comentarios, o sugerencias a<br>
        </p>
        <p class="u-align-left u-text u-text-3">
          <a class="u-active-none u-border-none u-btn u-button-link u-button-style u-hover-none u-none u-text-palette-1-base u-btn-1" href="mailto:yadiel.torres1@upr.edu">yadiel.torres1@upr.edu</a>
        </p>
      </div>
    </section>
    <section class="u-clearfix u-section-3" id="sec-47a6">
      <div class="u-clearfix u-sheet u-valign-top u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width-xs u-custom-html-1">
          <title></title>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico">
          <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="">
          <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
          <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
          <div id="mapid" style="width: 800px; height:600px;"></div>
          <div>
            <script> /////////////////////
        // Variables globales
        /////////////////////
            let mymap,
                url = "https://waterdata.usgs.gov/pr/nwis/uv/?format=rdb&site_no=",
                siteDict = {},
                fecha1 = Date(),
                dia = fecha1.slice(0,3),
                mes = fecha1.slice(4,7),
                hora = fecha1.slice(16,18),
                nameDia = { "Mon":"Lunes", "Tue":"Martes", "Wed":"Miércoles",
                             "Thu":"Jueves", "Fri":"Viernes", "Sat":"Sábado",
                             "Sun":"Domingo"},
                nameMes = { "Jan":"Enero", "Feb":"Febrero", "Mar":"Marzo",
                             "Apr":"Abril", "May":"Mayo", "Jun":"Junio",
                             "Jul":"Julio", "Aug":"Agosto", "Sep":"Septiembre",
                             "Oct":"Octubre", "Nov":"Noviembre", "Dic":"Diciembre"},
                horas = { "00":"12", "01":"1", "02":"2", "03":"3", "04":"4", "05":"5",
                          "06":"6", "07":"7", "08":"8", "09":"9", "10":"10", "11":"11",
                          "12":"12", "13":"1", "14":"2", "15":"3", "16":"4", "17":"5",
                          "18":"6", "19":"7", "20":"8", "21":"9", "22":"10", "23":"11" },
                numero_rios = [50059000, 50045000, 50076800, 50047550,
                               50093045, 50111210, 50039995, 50026140,
                               50071225, 50010800, 50113950];
        ///////////////////////////////////
        // Funcion para inicializar el mapa
        ///////////////////////////////////
            function inicializaMapa()
            {
                let centro = [18.25178,-66.254513];
                mymap = L.map('mapid').setView(centro, 9);
                let atrib1 = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">';
                let atrib2 = 'OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>';let atrib  = atrib1 + atrib2;
                let mytoken = 'pk.eyJ1IjoibWVjb2JpIiwiYSI6IjU4YzVlOGQ2YjEzYjE3NTcxOTExZTI2OWY3Y2Y1ZGYxIn0.LUg7xQhGH2uf3zA57szCyw';
                let myLayer = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}';
                L.tileLayer(myLayer, {
                    attribution: atrib,
                    maxZoom: 24,
                    id: 'mapbox/streets-v11',
                    tileSize: 512,
                    zoomOffset: -1,
                    accessToken: mytoken}).addTo(mymap);
            }
  
        //////////
        // Leyenda 
        //////////
            
            function leyendamostrar()
            {
                var leyenda = L.control({position: 'bottomleft'});
                leyenda.onAdd = function (mymap)
                {
                    var div = L.DomUtil.create('div', 'info leyenda'),
                        niveles = ['Seguridad', 'Ajuste', 'Control', 'Observacion'],
                        colores = ['green', 'blue', 'yellow', 'darkorange'];
                    div.innerHTML += "<h4>Nivel</h4>";
                    for(let i=0; i < 4; i++)
                    {
                        div.innerHTML += '<i style="background:'+colores[i]+'"></i><span>'+niveles[i]+'</span><br>';
                    }
                    return div;
                };
                leyenda.addTo(mymap);
            }
        ///////////////////////////////
        // Funcion que muestra la fecha
        ///////////////////////////////
  
            function actualizar()
            {
                var actualizacion = L.control({position: 'bottomright'});
                actualizacion.onAdd = function(mymap)
                {
                    var div2 = L.DomUtil.create('div', 'actualizacion');
                    if (fecha1.slice(16,18) >= 12)
                    {
                        div2.innerHTML += "<h4>Última actualización: "+(nameDia[dia]+" "+fecha1.slice(8,10)+" de "+nameMes[mes]+" del "+fecha1.slice(11,15)+" "+horas[hora]+fecha1.slice(18,24)+" PM")+"</h4>";
                    }
                    else
                    {
                        div2.innerHTML += "<h4>Última actualización: "+(nameDia[dia]+" "+fecha1.slice(8,10)+" de "+nameMes[mes]+" del "+fecha1.slice(11,15)+" "+horas[hora]+fecha1.slice(18,24)+" AM")+"</h4>"; 
                    }
                    return div2;
                };
                actualizacion.addTo(mymap);
            }
        ////////////////////////////////////////////////////////////////////
        // Funcion la cual crea un diccionario con los datos de los embalses
        ////////////////////////////////////////////////////////////////////
            function createDictionary()
            {
                let url ="https://raw.githubusercontent.com/mecobi/archivos_ejemplo/main/embalses.csv";
                Plotly.d3.csv(url,function(data){
                    for(let i=0;i < data.length;i++)
                    {
                        siteDict[data[i].siteID] = {nombre:data[i].nombre,
                                                    lat:data[i].latitude,
                                                    lon:data[i].longitude,
                                                    desborde:data[i].desborde,
                                                    seguridad:data[i].seguridad,
                                                    observacion:data[i].observacion,
                                                    ajuste:data[i].ajuste,
                                                    control:data[i].control};
                    }});
            }
        //////////////////////////////////////////////////////////////////////////
        // Funcion para filtrar la fecha y nivel de los embalses en el diccionario
        //////////////////////////////////////////////////////////////////////////
            function filtraDatos(data)
            {
              let fecha = [],
                  nivel = [];
              
              const filtered = data.split('\n');
              let colNivel;
              
              for(let i=0;i < filtered.length;i++)
              {
                if (filtered[i].slice(0,9) == "agency_cd")
                {
                  let header = filtered[i].split("\t");
                  colNivel = header.findIndex(element => element.includes("_62616"))
                }
                
                if(filtered[i].slice(0,4) == "USGS")
                {
                  let fila = filtered[i].split('\t');
                  fecha.push(fila[2]);
                  nivel.push(parseFloat(fila[colNivel]));
                }
              }
              return [fecha,nivel];
            }
        ////////////////////////////////////////////////////////
        // Funcion que devuelve la normalizacion de los embalses
        ////////////////////////////////////////////////////////
            function normalizacion(nivel, control, desborde)
            {
                let num = nivel - control,
                    denominado = desborde - control,
                    normalizacion = (num/denominado);
                    return normalizacion;
            }
        //////////////////////////////////////////////////////////
        // Funcion que devuelve el nivel pendiente de los embalses
        //////////////////////////////////////////////////////////
            function tendencia(fecha, nivel)
            {
                let now = Date().slice(8,10),
                    tendencia =[];
                for(let i=0;i < nivel.length;i++)
                {
                    if (fecha[i].slice(8,10) == now)
                    {
                        tendencia.push(parseFloat(nivel[i]));
                    }
                }
                let pendiente = tendencia[tendencia.length -1] - tendencia[0];
                return pendiente; 
            }
        ////////////////////////////////////////////////
        // Funcion que crea marcadores para cada embalse
        ////////////////////////////////////////////////
            function createMarker(miEmbalse)
            {
                Plotly.d3.text("https://waterdata.usgs.gov/pr/nwis/uv/?format=rdb&site_no=" + miEmbalse, function(data){
                    let datos = filtraDatos(data),
                    lat = siteDict[miEmbalse].lat,
                    lon = siteDict[miEmbalse].lon,
                    nombre = siteDict[miEmbalse].nombre,
                    desborde = parseFloat(siteDict[miEmbalse].desborde),
                    seguridad = parseFloat(siteDict[miEmbalse].seguridad),
                    observacion = parseFloat(siteDict[miEmbalse].observacion),
                    ajuste = parseFloat(siteDict[miEmbalse].ajuste),
                    control = parseFloat(siteDict[miEmbalse].control),
                    nivel = datos[1].pop(),
                    nivel_pend = datos[1], 
                    fecha = datos[0],
                    pendiente = tendencia(fecha, nivel_pend),
                    mensaje = "Sup..soy " + nombre + " <br> Mi nivel es " + parseFloat(nivel).toFixed(2) + " metros",
                    rect1, rect2, rect3, rect4, rect5, rect6, rect7,
                    icono, marcadorIcono, marcadorTend, color,
                    
                    //////////////////////////////////////////////////
                    // norm1 y nivel_1 son variables para nivel
                    // norm2 y nivel_2 son variables para desborde
                    // norm3 y nivel_3 son variables para seguridad
                    // norm4 y nivel_4 son variables para observacion
                    // norm5 y nivel_5 son variables para ajuste
                    // norm5 y nivel_6 son variables para ajuste
                    //////////////////////////////////////////////////
                    
                    norm1 = normalizacion(nivel,control,desborde),
                    norm2 = normalizacion(desborde,control,desborde),
                    norm3 = normalizacion(seguridad,control,desborde),
                    norm4 = normalizacion(observacion,control,desborde),
                    norm5 = normalizacion(ajuste,control,desborde),
                    norm6 = normalizacion(control,control,desborde),
                    nivel_1 = (0.09 - (norm1/9).toFixed(2)),
                    nivel_2 = (0.09 - (norm2/9).toFixed(2)),
                    nivel_3 = (0.09 - (norm3/9).toFixed(2)),
                    nivel_4 = (0.09 - (norm4/9).toFixed(2)),
                    nivel_5 = (0.09 - (norm5/9).toFixed(2)),
                    nivel_6 = (0.09 - (norm6/9).toFixed(2)),
                    largo = 0.04;
                
                if (nivel_3 < 0){nivel_3=-nivel_3;}
                if (nivel_4 < 0){nivel_4=-nivel_4;}
                if (nivel_5 < 0){nivel_5=-nivel_5;}
                if (nivel_6 < 0){nivel_6=-nivel_6;}
                
                if (nivel >= seguridad){color = 'green';}
                else if (nivel >= observacion && nivel < seguridad){color = 'blue';}
                else if (nivel >= ajuste && nivel < observacion){color = 'yellow';}
                else if (nivel <= control){color = 'darkorange';}
                
                rect1 = L.rectangle([[lat-nivel_6.toFixed(2),lon-largo],[lat-nivel_1.toFixed(2),lon]],
                    {color: color,
                        colorOpacity:0.02,
                        fillColor:color,
                        fillOpacity:0.75,
                        weight: 0.5}).addTo(mymap);
                rect2 = L.rectangle([[lat-nivel_3.toFixed(2),lon],[lat-nivel_4.toFixed(2),lon-largo]],
                    {color: "blue",
                        colorOpacity:0.09,
                        fillColor:"black",
                        fillOpacity:0.02,
                        weight: 1.5}).addTo(mymap);
                rect3 = L.rectangle([[lat-nivel_4.toFixed(2),lon],[lat-nivel_5.toFixed(2),lon-largo]],
                    {color: "yellow",
                        colorOpacity:0.09,
                        fillColor:"black",
                        fillOpacity:0.02,
                        weight: 1.5}).addTo(mymap);
                rect4 = L.rectangle([[lat-nivel_5.toFixed(2),lon],[lat-nivel_1.toFixed(2),lon-largo]],
                    {color: "darkorange",
                        colorOpacity:0.09,
                        fillColor:"black",
                        fillOpacity:0.02,
                        weight: 1.5}).addTo(mymap);
                rect5 = L.rectangle([[lat-nivel_6.toFixed(2),lon],[lat-nivel_2.toFixed(2),lon-largo]],
                    {color: "black",
                        colorOpacity:0.09,
                        fillColor:"black",
                        fillOpacity:0.02,
                        weight: 2}).addTo(mymap);
                rect6 = L.rectangle([[lat-nivel_6.toFixed(2),lon],[lat-nivel_2.toFixed(2),lon-largo]],
                    {color: 'black',
                        colorOpacity: 0.09,
                        fillColor: 'white',
                        fillOpacity: 0.01}).addTo(mymap);
                rect7 = L.rectangle([[lat-nivel_6.toFixed(2),lon],[lat-nivel_2.toFixed(2),lon-largo]],
                    {color: 'black',
                        colorOpacity: 0.9,
                        fillColor: color,
                        fillOpacity: 0.75}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
                rect6.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
                    .on('popupopen', function(e) {graficaDatos(datos, nombre, datos[1].slice(-1))});
                rect7.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
                    .on('popupopen', function(e) {graficaDatos(datos, nombre, datos[1].slice(-1))});
                
                if(pendiente > 0)
                {icono= 'https://cdn0.iconfinder.com/data/icons/flat-round-arrow-arrow-head/512/Green_Arrow_Top-512.png?raw=true';}
                else if(pendiente == 0)
                {icono= 'https://cdn0.iconfinder.com/data/icons/ui-essence/32/_26ui-512.png?raw=true';}
                else if(pendiente < 0)
                {icono= 'https://cdn0.iconfinder.com/data/icons/flat-round-arrow-arrow-head/512/Red_Arrow_Down-512.png?raw=true';}
                
                marcadorIcono = L.icon({iconUrl: icono, iconSize: [25,25], iconAnchor: [15,30], className: 'icono'});
                marcadorTend = L.marker([lat-nivel_2.toFixed(2)+0.017,lon-0.015], {icon: marcadorIcono}).addTo(mymap);
                });
            }
        /////////////////////////////////////////////////////
        // Funcion para crear las graficas de cada lago o río
        /////////////////////////////////////////////////////
            function graficaDatos(filtrado, myDiv)
            {
                let nivel = filtrado[1].pop();
                let trace = {
                    x: filtrado[0],
                    y: filtrado[1],
                    type: 'scatter',
                    line: {
                        color: 'red',
                        width: 2 }, };
  
                let layout = {
                    width:380,
                    height: 280,
                    paper_bgcolor: "lightblue",
                    plot_bgcolor: "#ddd",
      
                    title: {
                        text:"<b>" + myDiv + "<br>Nivel actual: </b>" + parseFloat(nivel).toFixed(2) + " metros" + "</br>",
                        font: { color:'black', family: 'Arial', size: 24 }},
      
                    xaxis: {
                        title: {
                            text: "<b>Fecha/Hora<b>", },
                        linecolor:'black',
                        mirror: true,
                        gridwidth:2,
                        gridcolor:'grey',
                        gridwidth:1, },
      
                    yaxis: {
                        title: {
                            text: "<b>Nivel[m]<b>", },
                        linecolor:'black',
                        mirror: true,
                        gridcolor:'grey',
                        gridwidth:1,
                        tickformat: ".2f", }, }
    
                let graphData = [trace];
                Plotly.newPlot('plot',graphData,layout);  
}
                
        //////////////////////////////
        // Funcion que imprime el mapa
        //////////////////////////////
            function procesaEmbalse()
            {
                for(const [key,value] of Object.entries(siteDict))
                {
                    createMarker(key);
                }
            }
            createDictionary();
            inicializaMapa();
            leyendamostrar();
            actualizar();
            setTimeout(procesaEmbalse,500); </script>
          </div>
          <style> .leyenda {
      padding: 6px 8px;
      font: 14px Arial, Helvetica, sans-serif;
      background: black;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      line-height: 24px;
      color: #555;
    }
    .actualizacion {
      padding: 6px 8px;
      font: 14px Arial, Helvetica, sans-serif;
      background: black;
      opacity: 0.75;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      line-height: 24px;
      color: #555;
    }
    .actualizacion h4 {
      text-align: center;
      font-size: 18px;
      margin: 2px 12px 8px;
      color: white;
      opacity: 0.85;
    }
    .leyenda h4 {
      text-align: center;
      font-size: 18px;
      margin: 2px 12px 8px;
      color: white;
      opacity: 0.85;
    }
    .leyenda span {
      position: relative;
      bottom: 3px;
      color: white;
      opacity: 0.85;
    }
    .leyenda i {
      width: 18px;
      height: 18px;
      float: left;
      margin: 0 8px 0 0;
      opacity: 0.75;
    } </style>
        </div>
      </div>
    </section>
    
    
    <footer class="u-align-center u-clearfix u-footer u-grey-80 u-footer" id="sec-985b"><div class="u-clearfix u-sheet u-valign-middle u-sheet-1">
        <p class="u-align-center u-small-text u-text u-text-variant u-text-1">© Copyright. 2021, Yadiel Torres. Todos los derechos reservados.</p>
      </div></footer>
  </body>
</html>